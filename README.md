# Checking Repeatable Read Consistency for MariaDB / Galera Cluster 

The whole Galera Cluster environment is established on Emulab.

```
MariaDB version == 10.4.22
Galera Cluster version == 26.4.9
```

# Example Result
The given data in folder [output/0/](./output/0/) was generated by Galera engineer from a single MariaDB node, with Galera replication disabled. It violates `Property Four` defined in this script. 

Parameters:
```
key_num = 20
client_num = 10
transactions_per_client = 100
operations_per_transaction = 25
```
# Running Steps

### Run [setup_server_node.sh](./setup_server_node.sh) and [setup_client_node.sh](./setup_client_node.sh) to set up Galera on server and client nodes respectively.

For three server nodes, change the `cluster_name` and `server_ip` in the script. Then run
```
sh setup_server_node.sh <server_node_no>
```
For the client nodes, run
```
sh setup_client_node.sh <server_ip_address>
```
### Run [init.sh](./init.sh) to initialize the Database in Galera Cluster.

Need to change the parameter `key` if you want to customize the key number.
```
python3 init.py <server_ip_address>
```
### Run  [galera.py](./galera.py) to generate transaction workloads. 

Please make sure the `server_id` are correct, and the `key_num` is same with settings in `init.py`. Then run
```
python3 galera.py -w <wo_rate> -r <ro_rate> -p <w_percent> -t <trans_num> -o <op_num> -c <client_num> -n <thread_no> -f <folder_num>
```
The collected traces will be stored in folder `output/folder_num/` where the trace for each client will be stored in a separate txt file; The default `folder_num` is 0.

To be noticed, all the read-write transactions generated by this script has been customized, that is, for each transaction, all the read operations will happen before write operations. Therefore, you cannot detect `Property Two` violation in the generated results. This part can be modified in function `zipf_generator` and `uniform_generator`.

### Run [group_data.py](./group_data.py) to normalize the collected data into one file result.txt.
```
python3 group_data.py -o <operation_num> -r <running_times>
```
The parameter `running_times` refers to run times `j` in [multi_threads.sh](./multi_threads.sh).

### Run [check_rr.py](./check_rr.py) to check if the execution run violates Repeatable Read consistency.

The format of each operation is: `read/write(variable, value, client_id, transaction_id)`, denote as `r/w(var, val, cid, tid)`
* Property One:

    For each Read operation `r(var, val, cid_1, tid_1)`, then the related Write operation `w(var, val, cid_2, tid_2)` must be a committed operation, in other words, `tid_2` must be a committed transaction.
* Property Two:

    For each Read operation `r(var, val_2, cid, tid)`, if there is a Write operation `w(var, val_1, cid, tid)` in the same transaction happened before this Read operation, then `val_1 = val_2`. Specifically, if there are multiple Write operations before the Read operation, the Read operation should return the value from the last Write operation.
* Property Three:

    For each Read operation `r(var, val, cid_1, tid_1)`, if the related Write operation `w(var, val, cid_2, tid_2)` is coming from a different transation `tid_2`, then the Write operation `w(var, val, cid_2, tid_2)` must be the last Write operation to `var` in trasaction `tid_2`.
* Property Four:

    For multiple Read operations in the same transaction, `r(var, val_1, cid, tid)` and `r(var, val_2, cid, tid)`, if there is no Write operation to `var` between them, then `val_1 = val_2`.
  
### Run [multi_threads.sh](./multi_threads.sh) to automatically generate workloads.

Please change all the parameters regarding `ip_address`.



 
 
